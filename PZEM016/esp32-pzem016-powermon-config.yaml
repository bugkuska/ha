
# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# =========================
# Template Sensors (ค่าไฟ)
# =========================
sensor:
  - platform: template
    sensors:

      # (ตัวเลือก) แสดงกำลังไฟฟ้า W จาก PZEM016
      pzem016_power_meter:
        friendly_name: "PZEM016 Power Meter"
        unit_of_measurement: "W"
        unique_id: pzem016_power_meter
        value_template: >
          {{ states('sensor.esp32_pzem016_powermon_power') | float(0) }}
        icon_template: mdi:flash

      cost_150:
        friendly_name: "Energy Cost 0-150 Unit"
        unit_of_measurement: "THB"
        unique_id: cost_150
        value_template: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set price_150 = 3.2484 %}
          {% if unit <= 150 %}
            {{ (unit * price_150) | round(2) }}
          {% else %}
            {{ (150 * price_150) | round(2) }}
          {% endif %}
        icon_template: mdi:transmission-tower

      cost_250:
        friendly_name: "Energy Cost 151-400 Unit"
        unit_of_measurement: "THB"
        unique_id: cost_250
        value_template: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set price_250 = 4.2218 %}
          {% if unit <= 150 %}
            {{ 0 | round(2) }}
          {% elif unit <= 400 %}
            {{ ((unit - 150) * price_250) | round(2) }}
          {% else %}
            {{ (250 * price_250) | round(2) }}
          {% endif %}
        icon_template: mdi:transmission-tower

      cost_400:
        friendly_name: "Energy Cost 400+ Unit"
        unit_of_measurement: "THB"
        unique_id: cost_400
        value_template: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set price_400 = 4.4217 %}
          {% if unit < 400 %}
            {{ 0 | round(2) }}
          {% else %}
            {{ ((unit - 400) * price_400) | round(2) }}
          {% endif %}
        icon_template: mdi:transmission-tower

      base_cost:
        friendly_name: "Base Energy Cost"
        unit_of_measurement: "THB"
        unique_id: base_cost
        value_template: >
          {% set c150 = states('sensor.cost_150') | float(0) %}
          {% set c250 = states('sensor.cost_250') | float(0) %}
          {% set c400 = states('sensor.cost_400') | float(0) %}
          {{ (c150 + c250 + c400) | round(2) }}
        icon_template: mdi:cash-100

      base_cost_services_charge:
        friendly_name: "Base Energy Cost + Service Charge"
        unit_of_measurement: "THB"
        unique_id: base_cost_services_charge
        value_template: >
          {% set base = states('sensor.base_cost') | float(0) %}
          {% set svc  = states('input_number.servicecharge') | float(0) %}
          {{ (base + svc) | round(2) }}
        icon_template: mdi:cash-plus

      ft_cost:
        friendly_name: "FT Cost"
        unit_of_measurement: "THB"
        unique_id: ft_cost
        value_template: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set ft   = states('input_number.ftcharge') | float(0) %}
          {{ (unit * ft) | round(2) }}
        icon_template: mdi:flash

      vat_7_percent:
        friendly_name: "VAT 7%"
        unit_of_measurement: "THB"
        unique_id: vat_7_percent
        value_template: >
          {% set a = states('sensor.base_cost_services_charge') | float(0) %}
          {% set b = states('sensor.ft_cost') | float(0) %}
          {{ ((a + b) * 0.07) | round(2) }}
        icon_template: mdi:percent

      total_cost:
        friendly_name: "Total Cost"
        unit_of_measurement: "THB"
        unique_id: total_cost
        value_template: >
          {% set a = states('sensor.base_cost_services_charge') | float(0) %}
          {% set b = states('sensor.ft_cost') | float(0) %}
          {% set v = states('sensor.vat_7_percent') | float(0) %}
          {{ (a + b + v) | round(2) }}
        icon_template: mdi:cash-check


# =========================
# Utility Meter (สะสมรายวัน/รายเดือน)
# =========================
utility_meter:
  daily_energy:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: daily
    offset:
      hours: 0
      minutes: 0

  monthly_energy:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: monthly
    offset:
      days: 1
      hours: 0
      minutes: 0

# =========================
# Input Number (Services & ft)
# =========================
input_number:
  servicecharge:
    name: Service Charge
    icon: mdi:cash-100
    min: 0
    max: 100
    step: 0.01
    mode: box

  ftcharge:
    name: FT Charge
    icon: mdi:flash
    min: 0
    max: 100
    step: 0.0001
    mode: box

