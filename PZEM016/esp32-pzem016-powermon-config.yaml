# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# =========================
# Modern Template Sensors (ค่าไฟ)
# =========================
template:
  - sensor:
      # (ตัวเลือก) แสดงกำลังไฟฟ้า W จาก PZEM016
      - name: "PZEM016 Power Meter"
        unique_id: pzem016_power_meter
        unit_of_measurement: "W"
        icon: mdi:flash
        state: "{{ states('sensor.esp32_pzem016_powermon_power') | float(0) }}"

      - name: "Energy Cost 0-150 Unit"
        unique_id: cost_150
        unit_of_measurement: "THB"
        icon: mdi:transmission-tower
        state: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set price_150 = 3.2484 %}
          {% if unit <= 150 %}
            {{ (unit * price_150) | round(2) }}
          {% else %}
            {{ (150 * price_150) | round(2) }}
          {% endif %}

      - name: "Energy Cost 151-400 Unit"
        unique_id: cost_250
        unit_of_measurement: "THB"
        icon: mdi:transmission-tower
        state: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set price_250 = 4.2218 %}
          {% if unit <= 150 %}
            {{ 0 }}
          {% elif unit <= 400 %}
            {{ ((unit - 150) * price_250) | round(2) }}
          {% else %}
            {{ (250 * price_250) | round(2) }}
          {% endif %}

      - name: "Energy Cost 400+ Unit"
        unique_id: cost_400
        unit_of_measurement: "THB"
        icon: mdi:transmission-tower
        state: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set price_400 = 4.4217 %}
          {% if unit < 400 %}
            {{ 0 }}
          {% else %}
            {{ ((unit - 400) * price_400) | round(2) }}
          {% endif %}

      - name: "Base Energy Cost"
        unique_id: base_cost
        unit_of_measurement: "THB"
        icon: mdi:cash-100
        state: >
          {% set c150 = states('sensor.cost_150') | float(0) %}
          {% set c250 = states('sensor.cost_250') | float(0) %}
          {% set c400 = states('sensor.cost_400') | float(0) %}
          {{ (c150 + c250 + c400) | round(2) }}

      - name: "Base Energy Cost + Service Charge"
        unique_id: base_cost_services_charge
        unit_of_measurement: "THB"
        icon: mdi:cash-plus
        state: >
          {% set base = states('sensor.base_cost') | float(0) %}
          {% set svc  = states('input_number.servicecharge') | float(0) %}
          {{ (base + svc) | round(2) }}

      - name: "FT Cost"
        unique_id: ft_cost
        unit_of_measurement: "THB"
        icon: mdi:flash
        state: >
          {% set unit = states('sensor.monthly_energy') | float(0) %}
          {% set ft   = states('input_number.ftcharge') | float(0) %}
          {{ (unit * ft) | round(2) }}

      - name: "VAT 7%"
        unique_id: vat_7_percent
        unit_of_measurement: "THB"
        icon: mdi:percent
        state: >
          {% set a = states('sensor.base_cost_services_charge') | float(0) %}
          {% set b = states('sensor.ft_cost') | float(0) %}
          {{ ((a + b) * 0.07) | round(2) }}

      - name: "Total Cost"
        unique_id: total_cost
        unit_of_measurement: "THB"
        icon: mdi:cash-check
        state: >
          {% set a = states('sensor.base_cost_services_charge') | float(0) %}
          {% set b = states('sensor.ft_cost') | float(0) %}
          {% set v = states('sensor.vat_7_percent') | float(0) %}
          {{ (a + b + v) | round(2) }}


# =========================
# Utility Meter (สะสมรายวัน/รายเดือน)
# =========================
utility_meter:
  daily_energy:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: daily
    offset:
      hours: 0
      minutes: 0

  monthly_energy:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: monthly
    offset:
      days: 1
      hours: 0
      minutes: 0


# =========================
# Input Number (Services & ft)
# =========================
input_number:
  servicecharge:
    name: Service Charge
    icon: mdi:cash-100
    min: 0
    max: 100
    step: 0.01
    mode: box

  ftcharge:
    name: FT Charge
    icon: mdi:flash
    min: 0
    max: 100
    step: 0.0001
    mode: box
